---
title: "Replication - Main Tables"
output:
  pdf_document: default
  html_document: 
    css: |
      body {
        word-wrap: break-word;
        overflow-wrap: break-word;
      }
      pre {
        white-space: pre-wrap;
      }
date: "2025-06-15"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  tidy = TRUE,
  tidy.opts = list(width.cutoff = 60),
  fig.width = 6,
  fig.height = 4
)
options(width = 60)
```



# Replication of the main tables


## Table 1 - Incumbent 2010

Required libraries.

```{r}
library(tidyverse)
library(stargazer)
library(knitr)
library(broom)
library(haven)
library(fixest)
library(modelsummary)
library(gt)
library(webshot2)
library(car)
```


Defining the control and dependent variables.
```{r}
gpcontrols <- c("GP_population", "GP_lit", "GP_sc", "GP_st", "GP_nbvillages",
                "RES00_gender", "RES00_obc", "RES00_sc", "RES00_st",
                "RES10_obc", "RES10_sc", "RES10_st", "RES05_obc", "RES05_sc", "RES05_st")


incum_dep_vars1 <- c("INC05_running", "INC05_voteshare",
                     "INCSPOUSE05_running", "INCSPOUSE05_voteshare",
                     "INCOTHER05_running", "INCOTHER05_voteshare")
```


Loading the data and filtering it.
```{r}
data <- read_dta("~/work/Electoral data cleaned.dta")


data_filtered <- data %>%
  filter(RES10_gender == 0 & SAMPLE_hhsurvey == 1 & GP_tag == 1 & INC05_can_run == 1) %>%
  mutate(
    FAMnotINC05_running = INCorFAM05_running - INC05_running,
    FAMnotINC05_voteshare = INCorFAM05_voteshare - INC05_voteshare,
    FAMnotINC05_won = INCorFAM05_won - INC05_won
  )
```


Function for the regression formulas.
```{r}
create_formula <- function(dep_var, model_type) {
  base_controls <- paste(gpcontrols, collapse = " + ")
  
  if (model_type == "any_treatment") {
    formula_str <- paste(dep_var, "~ INT_treatment + RES05_gender + INT_treatment:RES05_gender +",
                         base_controls, "+ factor(district)")
  } else if (model_type == "gender_general") {
    formula_str <- paste(dep_var, "~ INT_treatment_gender + INT_treatment_general + RES05_gender + INT_treatment_gender:RES05_gender + INT_treatment_general:RES05_gender +",
                         base_controls, "+ factor(district)")
  }
  
  return(as.formula(formula_str))
}
```

Function for the statistical tests. 
```{r}
calculate_tests <- function(model, model_type) {
  if (model_type == "any_treatment") {
    test1 <- tryCatch({
      car::linearHypothesis(model, "RES05_gender = 0")
    }, error = function(e) list(PrF = NA))
    pval1 <- if (!is.null(test1$PrF)) round(test1$`Pr(>F)`[2], 2) else NA
    
    test2 <- tryCatch({
      car::linearHypothesis(model, "INT_treatment:RES05_gender = 0")
    }, error = function(e) list(PrF = NA))
    pval2 <- if (!is.null(test2$PrF)) round(test2$`Pr(>F)`[2], 2) else NA
    
    test3 <- tryCatch({
      car::linearHypothesis(model, "INT_treatment = INT_treatment:RES05_gender")
    }, error = function(e) list(PrF = NA))
    pval3 <- if (!is.null(test3$PrF)) round(test3$`Pr(>F)`[2], 2) else NA
    
    return(list(pval1 = pval1, pval2 = pval2, pval3 = pval3))
  } else if (model_type == "gender_general") {
    test1 <- tryCatch({
      car::linearHypothesis(model, "INT_treatment_gender:RES05_gender = 0")
    }, error = function(e) list(PrF = NA))
    pval1 <- if (!is.null(test1$PrF)) round(test1$`Pr(>F)`[2], 2) else NA
    
    test2 <- tryCatch({
      car::linearHypothesis(model, "INT_treatment_general:RES05_gender = 0")
    }, error = function(e) list(PrF = NA))
    pval2 <- if (!is.null(test2$PrF)) round(test2$`Pr(>F)`[2], 2) else NA
    
    test3 <- tryCatch({
      car::linearHypothesis(model, "INT_treatment_gender = INT_treatment_general")
    }, error = function(e) list(PrF = NA))
    pval3 <- if (!is.null(test3$PrF)) round(test3$`Pr(>F)`[2], 2) else NA
    
    test4 <- tryCatch({
      car::linearHypothesis(model, "INT_treatment_gender:RES05_gender = INT_treatment_general:RES05_gender")
    }, error = function(e) list(PrF = NA))
    pval4 <- if (!is.null(test4$PrF)) round(test4$`Pr(>F)`[2], 2) else NA
    
    return(list(pval1 = pval1, pval2 = pval2, pval3 = pval3, pval4 = pval4))
  }
}

```


Estimating the models, starting by initialising lists of results.
```{r}
models_list <- list()
control_means <- list()
test_results <- list()
```


Models with "any treatment":
```{r}
for (i in 1:length(incum_dep_vars1)) {
  dep_var <- incum_dep_vars1[i]
  
  control_mean <- data_filtered %>%
    filter(INT_treatment == 0 & RES05_gender == 0) %>%
    summarise(mean = mean(!!sym(dep_var), na.rm = TRUE)) %>%
    pull(mean) %>%
    round(2)
  
  control_means[[i]] <- control_mean
  
  formula <- create_formula(dep_var, "any_treatment")
  model <- lm(formula, data = data_filtered)
  models_list[[i]] <- model
  
  test_results[[i]] <- calculate_tests(model, "any_treatment")
}
```


Models with "gender and general treatment":
```{r}
for (i in 1:length(incum_dep_vars1)) {
  dep_var <- incum_dep_vars1[i]
  j <- i + length(incum_dep_vars1)
  
  control_means[[j]] <- control_means[[i]]
  
  formula <- create_formula(dep_var, "gender_general")
  model <- lm(formula, data = data_filtered)
  models_list[[j]] <- model
  
  test_results[[j]] <- calculate_tests(model, "gender_general")
}
```


Variables to display and selection of columns and summary statistics (means and test results).
```{r}
outregvar2 <- c("INT_treatment", "INT_treatment_gender", "INT_treatment_general", "RES05_gender", "INT_treatment:RES05_gender", "INT_treatment_gender:RES05_gender", "INT_treatment_general:RES05_gender")


col_names <- c("Incumbent Runs", "Incumbent Vote Share",
               "Incumbent Spouse Runs", "Incumbent Spouse Vote Share",
               "Other Family Member Runs", "Other Family Member Vote Share")


additional_lines <- list(
  c("Observations", sapply(models_list, function(x) nobs(x))),
  c("Mean in Control without GQ", unlist(control_means)),
  c("Treatment with GQ = Treat without GQ", sapply(test_results[1:length(incum_dep_vars1)], function(x) x$pval3)),
  c("Gender Treat = General Treat without GQ", sapply(test_results[(length(incum_dep_vars1)+1):length(test_results)], function(x) x$pval3)),
  c("Gender Treat = General Treat with GQ", sapply(test_results[(length(incum_dep_vars1)+1):length(test_results)], function(x) x$pval4))
)
```


Generating the output table.
```{r}
stargazer(models_list,
          type = "text",
          column.labels = col_names,
          keep = outregvar2,
          add.lines = additional_lines,
          digits = 2,
          title = "Table 1: Effects on Incumbent and Family Candidate Entry",
          out = "Table1_Incumbent_2010_completed.txt")
```

Non formatted version of the table, to fit into the PDF.

```{r}
## CREATE OUTPUT TABLE FOR INCUMBENT ANALYSIS
create_outreg_table <- function(models_list, incum_dep_vars1, outregvar2, control_means, test_results) {
  
  # Function to extract model results
  extract_model_results <- function(model) {
    if (is.null(model)) return(NULL)
    
    summary_model <- summary(model)
    coef_table <- summary_model$coefficients
    
    results <- list()
    for (var in outregvar2) {
      matching_vars <- rownames(coef_table)[grepl(paste0("^", gsub(":", ":", var), "$"), rownames(coef_table))]
      if (length(matching_vars) > 0) {
        var_name <- matching_vars[1]
        coef_val <- coef_table[var_name, "Estimate"]
        se_val <- coef_table[var_name, "Std. Error"]
        pval <- coef_table[var_name, "Pr(>|t|)"]
        
        # Adding significance stars
        stars <- if (pval < 0.01) "***" else if (pval < 0.05) "**" else if (pval < 0.1) "*" else ""
        
        results[[var]] <- list(
          coef = round(coef_val, 3),
          se = round(se_val, 3),
          pval = pval,
          stars = stars,
          coef_formatted = paste0(round(coef_val, 3), stars),
          se_formatted = paste0("(", round(se_val, 3), ")")
        )
      } else {
        results[[var]] <- list(
          coef = NA,
          se = NA,
          pval = NA,
          stars = "",
          coef_formatted = "NA",
          se_formatted = "(NA)"
        )
      }
    }
    return(results)
  }
  
  # Create column names
  col_names <- c("Incumbent Runs", "Incumbent Vote Share",
                 "Incumbent Spouse Runs", "Incumbent Spouse Vote Share", 
                 "Other Family Member Runs", "Other Family Member Vote Share")
  
  # Initialize the final table
  final_table <- data.frame(
    Variable = character(),
    stringsAsFactors = FALSE
  )
  
  # Add columns for each dependent variable (both any_treatment and gender_general models)
  for (i in 1:length(incum_dep_vars1)) {
    final_table[[paste0(col_names[i], "_Any")]] <- character()
    final_table[[paste0(col_names[i], "_Detailed")]] <- character()
  }
  
  # Extract results for each variable
  for (var in outregvar2) {
    # Coefficient row
    coef_row <- data.frame(Variable = var, stringsAsFactors = FALSE)
    se_row <- data.frame(Variable = paste0("  ", var, "_se"), stringsAsFactors = FALSE)
    
    # For each dependent variable
    for (i in 1:length(incum_dep_vars1)) {
      # Any treatment model (first 6 models)
      any_results <- extract_model_results(models_list[[i]])
      coef_row[[paste0(col_names[i], "_Any")]] <- if (!is.null(any_results[[var]])) any_results[[var]]$coef_formatted else "NA"
      se_row[[paste0(col_names[i], "_Any")]] <- if (!is.null(any_results[[var]])) any_results[[var]]$se_formatted else "(NA)"
      
      # Gender/General treatment model (models 7-12)
      detailed_results <- extract_model_results(models_list[[i + length(incum_dep_vars1)]])
      coef_row[[paste0(col_names[i], "_Detailed")]] <- if (!is.null(detailed_results[[var]])) detailed_results[[var]]$coef_formatted else "NA"
      se_row[[paste0(col_names[i], "_Detailed")]] <- if (!is.null(detailed_results[[var]])) detailed_results[[var]]$se_formatted else "(NA)"
    }
    
    final_table <- rbind(final_table, coef_row, se_row)
  }
  
  # Add additional statistics rows
  # Observations
  obs_row <- data.frame(Variable = "Observations", stringsAsFactors = FALSE)
  for (i in 1:length(incum_dep_vars1)) {
    obs_row[[paste0(col_names[i], "_Any")]] <- nobs(models_list[[i]])
    obs_row[[paste0(col_names[i], "_Detailed")]] <- nobs(models_list[[i + length(incum_dep_vars1)]])
  }
  final_table <- rbind(final_table, obs_row)
  
  # Control means
  mean_row <- data.frame(Variable = "Mean in Control without GQ", stringsAsFactors = FALSE)
  for (i in 1:length(incum_dep_vars1)) {
    mean_row[[paste0(col_names[i], "_Any")]] <- control_means[[i]]
    mean_row[[paste0(col_names[i], "_Detailed")]] <- control_means[[i]]
  }
  final_table <- rbind(final_table, mean_row)
  
  # Test results
  test1_row <- data.frame(Variable = "Treatment with GQ = Treat without GQ", stringsAsFactors = FALSE)
  for (i in 1:length(incum_dep_vars1)) {
    test1_row[[paste0(col_names[i], "_Any")]] <- test_results[[i]]$pval3
    test1_row[[paste0(col_names[i], "_Detailed")]] <- ""
  }
  final_table <- rbind(final_table, test1_row)
  
  test2_row <- data.frame(Variable = "Gender Treat = General Treat without GQ", stringsAsFactors = FALSE)
  for (i in 1:length(incum_dep_vars1)) {
    test2_row[[paste0(col_names[i], "_Any")]] <- ""
    test2_row[[paste0(col_names[i], "_Detailed")]] <- test_results[[i + length(incum_dep_vars1)]]$pval3
  }
  final_table <- rbind(final_table, test2_row)
  
  test3_row <- data.frame(Variable = "Gender Treat = General Treat with GQ", stringsAsFactors = FALSE)
  for (i in 1:length(incum_dep_vars1)) {
    test3_row[[paste0(col_names[i], "_Any")]] <- ""
    test3_row[[paste0(col_names[i], "_Detailed")]] <- test_results[[i + length(incum_dep_vars1)]]$pval4
  }
  final_table <- rbind(final_table, test3_row)
  
  return(final_table)
}

# Create the main table
main_table <- create_outreg_table(models_list, incum_dep_vars1, outregvar2, control_means, test_results)

# Display the table
print(main_table)
```





## Table 2 - Performance 2010

Required libraries:
```{r}
library(tidyverse)
library(fixest)
library(stargazer)
library(haven)
library(lmtest)
```

Defining the macros: control variables and variables related to the regression.

```{r}
# Control variables
gpcontrols <- c("GP_population", "GP_lit", "GP_sc", "GP_st", "GP_nbvillages",
                "RES00_gender", "RES00_obc", "RES00_sc", "RES00_st",
                "RES10_obc", "RES10_sc", "RES10_st", "RES05_obc", "RES05_sc", "RES05_st")

# Regression variables
outregvar2 <- c("INT_treatment", "RES05_gender", "X_anytr_genderres05")
```

Data processing: uploading, filtering.

```{r}
# Change path accordingly to your workspace.
data <- read_dta("~/work/Electoral data cleaned.dta")

# Filtering the data
data_filtered <- data %>%
  filter(RES10_gender == 0, SAMPLE_hhsurvey == 1, GP_tag == 1, INC05_can_run == 1) %>%
  mutate(
    FAMnotINC05_running = INCFAM05_running - INC05_running,
    FAMnotINC05_voteshare = INCFAM05_voteshare - INC05_voteshare,
    FAMnotINC05_won = INCFAM05_won - INC05_won
  )
```

Generation of the performance indices of the program.
```{r}
data_filtered <- data_filtered %>%
  mutate(
    index_empl_svy_0 = rowMeans(select(., std_HH_NREGA, std_HH_NREGA_unmet_demand_m, std_HH_NREGA_unmet_demand_f), na.rm = TRUE),
    index_empl_svy_1 = rowMeans(select(., std_HH_NREGA_unmet_demand, std_HH_NREGA_unmet_demand_m, std_HH_NREGA_unmet_demand_f, std_HH_NREGA_waiting_time_m, std_HH_NREGA_waiting_time_f, std_HH_NREGA, std_HH_NREGA_work_m, std_HH_NREGA_work_f), na.rm = TRUE),
    index_empl_svy_2 = rowMeans(select(., std_HH_NREGA, std_HH_NREGA_work_m, std_HH_NREGA_work_f), na.rm = TRUE),
    index_empl_svy_3 = rowMeans(select(., std_HH_NREGA_unmet_demand_m, std_HH_NREGA_unmet_demand_f), na.rm = TRUE)
  )
```

Dependent variables.
```{r}
incum_dep_vars1 <- c("INC05_running", "INC05_voteshare", "INC05_won",
                     "INCSPOUSE05_running", "INCSPOUSE05_voteshare", "INCSPOUSE05_won",
                     "INCOTHER05_running", "INCOTHER05_voteshare", "INCOTHER05_won")

indices <- c("index_empl_svy_0", "index_empl_svy_1", "index_empl_svy_2", "index_empl_svy_3")
```

Initialization of the lists for the upcoming results.
```{r}
models_list <- list()
control_means <- numeric(length(incum_dep_vars1) * length(indices))
pvals_1 <- numeric(length(incum_dep_vars1) * length(indices))
pvals_2 <- numeric(length(incum_dep_vars1) * length(indices))
effect_average <- numeric(length(incum_dep_vars1) * length(indices))
effect_good <- numeric(length(incum_dep_vars1) * length(indices))
effect_bad <- numeric(length(incum_dep_vars1) * length(indices))
```

Doing the regressions.
```{r, results='hide'}
i <- 0
for (x in 0:1) {
  for (dep_var in incum_dep_vars1) {
    for (index in indices) {
      i <- i + 1
      
      # control mean
      control_mean <- data_filtered %>%
        filter(INT_treatment == 0 & RES05_gender == x) %>%
        summarise(mean = mean(!!sym(dep_var), na.rm = TRUE)) %>%
        pull(mean) %>%
        round(2)
      
      control_means[i] <- control_mean
      
      # mean and standard error of the index
      index_stats <- data_filtered %>%
        filter(RES05_gender == x) %>%
        summarise(mean = mean(!!sym(index), na.rm = TRUE),
                  sd = sd(!!sym(index), na.rm = TRUE))
      
      index_mean <- round(index_stats$mean, 2)
      index_sd <- round(index_stats$sd, 2)
      
      # interaction variables
      data_filtered <- data_filtered %>%
        mutate(
          TEMP_index = get(index),
          TEMP_X_res_index = RES05_gender * get(index),
          TEMP_X_anytr_index = INT_treatment * get(index),
          TEMP_X_anytr_res_index = INT_treatment * RES05_gender * get(index)
        )
      
      # checking that all the variables exist in the set
      all_vars <- c(dep_var, "INT_treatment", "TEMP_index", "TEMP_X_anytr_index", gpcontrols, "district")
      if (all(all_vars %in% names(data_filtered))) {
        # model estimation
        formula <- as.formula(paste(dep_var, "~ INT_treatment + TEMP_index + TEMP_X_anytr_index +", paste(gpcontrols, collapse = " + "), "+ factor(district)"))
        model <- tryCatch({
          lm(formula, data = data_filtered %>% filter(RES05_gender == x))
        }, error = function(e) {
          message("Error in model fitting: ", e$message)
          NULL
        })
        
        if (!is.null(model)) {
          models_list[[i]] <- model
          
          # doing the tests
          test_1 <- tryCatch({
            waldtest(model, c("INT_treatment + TEMP_X_anytr_index = 0", paste("TEMP_index =", index_mean)))
          }, error = function(e) {
            message("Error in test 1: ", e$message)
            NULL
          })
          
          if (!is.null(test_1)) {
            pvals_1[i] <- round(test_1$p.value, 2)
          } else {
            pvals_1[i] <- NA
          }
          
          test_2 <- tryCatch({
            waldtest(model, c("INT_treatment + TEMP_X_anytr_index = 0"))
          }, error = function(e) {
            message("Error in test 2: ", e$message)
            NULL
          })
          
          if (!is.null(test_2)) {
            pvals_2[i] <- round(test_2$p.value, 2)
          } else {
            pvals_2[i] <- NA
          }
          
          # effects
          effect_average[i] <- coef(model)["INT_treatment"] + coef(model)["TEMP_X_anytr_index"] * index_mean
          effect_good[i] <- coef(model)["INT_treatment"] + coef(model)["TEMP_X_anytr_index"] * (index_mean + index_sd)
          effect_bad[i] <- coef(model)["INT_treatment"] + coef(model)["TEMP_X_anytr_index"] * (index_mean - index_sd)
          
          # displaying said effects
          cat("Effects on outcome", dep_var, "\n")
          cat("Effect of treatment for average performing incumbent is", effect_average[i], "\n")
          cat("Effect of treatment for +1 sd performing incumbent is", effect_good[i], "\n")
          cat("Effect of treatment for -1 sd performing incumbent is", effect_bad[i], "\n")
        } else {
          message("Model fitting failed for ", dep_var)
        }
      } else {
        message("Some variables are missing in the dataset for ", dep_var)
      }
    }
  }
}
```

Generation of a table displaying the coefficients of interest.

```{r}
# Selection of the right models to display
panel_A_models <- models_list[c(1, 5, 13, 17, 25, 29)]
panel_B_models <- models_list[c(37, 41, 49, 53, 61, 65)]

# Panel A
panel_A <- stargazer(
  panel_A_models,
  type = "text",
  column.labels = c("Model 1", "Model 5", "Model 13", "Model 17", "Model 25", "Model 29"),
  keep = c("INT_treatment", "TEMP_index", "TEMP_X_anytr_index"),
  add.lines = list(
    c("District FE", rep("Yes", length(panel_A_models))),
    c("GP Controls", rep("Yes", length(panel_A_models))),
    c("Mean in Control not WR in 2005", control_means[c(1, 5, 13, 17, 25, 29)]),
    c("Test Treat Effect", pvals_1[c(1, 5, 13, 17, 25, 29)]),
    c("Test Perf Effect in Treat", pvals_2[c(1, 5, 13, 17, 25, 29)])
  ),
  digits = 2,
  title = "Panel A: GP without Gender Quota in 2005",
  single.row = TRUE
)

# Panel B
panel_B <- stargazer(
  panel_B_models,
  type = "text",
  column.labels = c("Model 37", "Model 41", "Model 49", "Model 53", "Model 61", "Model 65"),
  keep = c("INT_treatment", "TEMP_index", "TEMP_X_anytr_index"),
  add.lines = list(
    c("District FE", rep("Yes", length(panel_B_models))),
    c("GP Controls", rep("Yes", length(panel_B_models))),
    c("Mean in Control not WR in 2005", control_means[c(37, 41, 49, 53, 61, 65)]),
    c("Test Treat Effect", pvals_1[c(37, 41, 49, 53, 61, 65)]),
    c("Test Perf Effect in Treat", pvals_2[c(37, 41, 49, 53, 61, 65)])
  ),
  digits = 2,
  title = "Panel B: GP with Gender Quota in 2005",
  single.row = TRUE
)

# Combine the two in one txt doc
combined_output <- c(panel_A, "\n\n", panel_B)
writeLines(combined_output, file.path("~/work/Rajasthan-Voters-Replication/Table2_Performance_2010_completed.txt"))
```


Non formatted table, to fit into the PDF.
```{r}
create_reduced_performance_table <- function(models_list, control_means, pvals_1, pvals_2) {
  
  # Function to extract model results
  extract_model_results <- function(model) {
    if (is.null(model)) return(NULL)
    
    summary_model <- summary(model)
    coef_table <- summary_model$coefficients
    
    target_vars <- c("INT_treatment", "TEMP_index", "TEMP_X_anytr_index")
    
    results <- list()
    for (var in target_vars) {
      if (var %in% rownames(coef_table)) {
        coef_val <- coef_table[var, "Estimate"]
        se_val <- coef_table[var, "Std. Error"]
        pval <- coef_table[var, "Pr(>|t|)"]
        
        stars <- if (pval < 0.01) "***" else if (pval < 0.05) "**" else if (pval < 0.1) "*" else ""
        
        results[[var]] <- list(
          coef_formatted = paste0(round(coef_val, 3), stars),
          se_formatted = paste0("(", round(se_val, 3), ")")
        )
      } else {
        results[[var]] <- list(
          coef_formatted = "NA",
          se_formatted = "(NA)"
        )
      }
    }
    return(results)
  }
  
  # Selection of models to display
  panel_A_indices <- c(1, 5, 13, 17, 25, 29)
  panel_B_indices <- c(37, 41, 49, 53, 61, 65)
  
  # Column names for the selected models
  panel_A_cols <- c("Model_1", "Model_5", "Model_13", "Model_17", "Model_25", "Model_29")
  panel_B_cols <- c("Model_37", "Model_41", "Model_49", "Model_53", "Model_61", "Model_65")
  
  # Create Panel A table
  panel_A_table <- data.frame(Variable = character(), stringsAsFactors = FALSE)
  for (col in panel_A_cols) {
    panel_A_table[[col]] <- character()
  }
  
  # Create Panel B table
  panel_B_table <- data.frame(Variable = character(), stringsAsFactors = FALSE)
  for (col in panel_B_cols) {
    panel_B_table[[col]] <- character()
  }
  
  # Variables to extract
  vars_to_extract <- c("INT_treatment", "TEMP_index", "TEMP_X_anytr_index")
  
  # Fill Panel A
  for (var in vars_to_extract) {
    coef_row <- data.frame(Variable = var, stringsAsFactors = FALSE)
    se_row <- data.frame(Variable = paste0("  ", var, "_se"), stringsAsFactors = FALSE)
    
    for (i in 1:length(panel_A_indices)) {
      model_idx <- panel_A_indices[i]
      col_name <- panel_A_cols[i]
      
      if (model_idx <= length(models_list) && !is.null(models_list[[model_idx]])) {
        results <- extract_model_results(models_list[[model_idx]])
        coef_row[[col_name]] <- if (!is.null(results[[var]])) results[[var]]$coef_formatted else "NA"
        se_row[[col_name]] <- if (!is.null(results[[var]])) results[[var]]$se_formatted else "(NA)"
      } else {
        coef_row[[col_name]] <- "NA"
        se_row[[col_name]] <- "(NA)"
      }
    }
    
    panel_A_table <- rbind(panel_A_table, coef_row, se_row)
  }
  
  # Fill Panel B
  for (var in vars_to_extract) {
    coef_row <- data.frame(Variable = var, stringsAsFactors = FALSE)
    se_row <- data.frame(Variable = paste0("  ", var, "_se"), stringsAsFactors = FALSE)
    
    for (i in 1:length(panel_B_indices)) {
      model_idx <- panel_B_indices[i]
      col_name <- panel_B_cols[i]
      
      if (model_idx <= length(models_list) && !is.null(models_list[[model_idx]])) {
        results <- extract_model_results(models_list[[model_idx]])
        coef_row[[col_name]] <- if (!is.null(results[[var]])) results[[var]]$coef_formatted else "NA"
        se_row[[col_name]] <- if (!is.null(results[[var]])) results[[var]]$se_formatted else "(NA)"
      } else {
        coef_row[[col_name]] <- "NA"
        se_row[[col_name]] <- "(NA)"
      }
    }
    
    panel_B_table <- rbind(panel_B_table, coef_row, se_row)
  }
  
  # Add additional statistics to Panel A
  obs_row_A <- data.frame(Variable = "Observations", stringsAsFactors = FALSE)
  for (i in 1:length(panel_A_indices)) {
    model_idx <- panel_A_indices[i]
    col_name <- panel_A_cols[i]
    
    if (model_idx <= length(models_list) && !is.null(models_list[[model_idx]])) {
      obs_row_A[[col_name]] <- nobs(models_list[[model_idx]])
    } else {
      obs_row_A[[col_name]] <- "NA"
    }
  }
  panel_A_table <- rbind(panel_A_table, obs_row_A)
  
  mean_row_A <- data.frame(Variable = "Mean in Control not WR in 2005", stringsAsFactors = FALSE)
  for (i in 1:length(panel_A_indices)) {
    model_idx <- panel_A_indices[i]
    col_name <- panel_A_cols[i]
    mean_row_A[[col_name]] <- control_means[model_idx]
  }
  panel_A_table <- rbind(panel_A_table, mean_row_A)
  
  test1_row_A <- data.frame(Variable = "Test Treat Effect", stringsAsFactors = FALSE)
  test2_row_A <- data.frame(Variable = "Test Perf Effect in Treat", stringsAsFactors = FALSE)
  for (i in 1:length(panel_A_indices)) {
    model_idx <- panel_A_indices[i]
    col_name <- panel_A_cols[i]
    test1_row_A[[col_name]] <- pvals_1[model_idx]
    test2_row_A[[col_name]] <- pvals_2[model_idx]
  }
  panel_A_table <- rbind(panel_A_table, test1_row_A, test2_row_A)
  
  # Add additional statistics to Panel B
  obs_row_B <- data.frame(Variable = "Observations", stringsAsFactors = FALSE)
  for (i in 1:length(panel_B_indices)) {
    model_idx <- panel_B_indices[i]
    col_name <- panel_B_cols[i]
    
    if (model_idx <= length(models_list) && !is.null(models_list[[model_idx]])) {
      obs_row_B[[col_name]] <- nobs(models_list[[model_idx]])
    } else {
      obs_row_B[[col_name]] <- "NA"
    }
  }
  panel_B_table <- rbind(panel_B_table, obs_row_B)
  
  mean_row_B <- data.frame(Variable = "Mean in Control not WR in 2005", stringsAsFactors = FALSE)
  for (i in 1:length(panel_B_indices)) {
    model_idx <- panel_B_indices[i]
    col_name <- panel_B_cols[i]
    mean_row_B[[col_name]] <- control_means[model_idx]
  }
  panel_B_table <- rbind(panel_B_table, mean_row_B)
  
  test1_row_B <- data.frame(Variable = "Test Treat Effect", stringsAsFactors = FALSE)
  test2_row_B <- data.frame(Variable = "Test Perf Effect in Treat", stringsAsFactors = FALSE)
  for (i in 1:length(panel_B_indices)) {
    model_idx <- panel_B_indices[i]
    col_name <- panel_B_cols[i]
    test1_row_B[[col_name]] <- pvals_1[model_idx]
    test2_row_B[[col_name]] <- pvals_2[model_idx]
  }
  panel_B_table <- rbind(panel_B_table, test1_row_B, test2_row_B)
  
  return(list(panel_A = panel_A_table, panel_B = panel_B_table))
}

# Create the reduced tables
reduced_tables <- create_reduced_performance_table(models_list, control_means, pvals_1, pvals_2)

# Display the tables
print("=== PANEL A: GP without Gender Quota in 2005 ===")
print(reduced_tables$panel_A)

print("\n=== PANEL B: GP with Gender Quota in 2005 ===")
print(reduced_tables$panel_B)
```



## Table 3 - Challengers 2010

Required libraries.
```{r}
library(dplyr)
library(fixest)
library(stargazer)
library(haven)
library(broom)
library(aod)
```

Defining the macros: controls, interest and dependent variables.
```{r}
gpcontrols <- c("GP_population", "GP_lit", "GP_sc", "GP_st", "GP_nbvillages",
                "RES00_gender", "RES00_obc", "RES00_sc", "RES00_st",
                "RES10_obc", "RES10_sc", "RES10_st", "RES05_obc",
                "RES05_sc", "RES05_st")

outregvar2 <- c("INT_treatment", "RES05_gender", "X_anytr_genderres05")

dep_vars <- c("ELEC10_nbcands", "CHAL_nbchal", "CHAL_prop_female",
              "CHAL_voteshare_female", "CHAL_prop_nongen", "CHAL_voteshare_nongen")
```

Data processing.
```{r}
data_path <- "~/work/Electoral data cleaned.dta"
data <- read_dta(data_path)
data_filtered <- data %>% filter(RES10_gender == 0, GP_tag == 1)
```

Function for the regressions.

```{r}
run_regression_analysis <- function(data_subset, subset_name) {
  cat(paste("\n=== ANALYZE FOR:", subset_name, "===\n"))
  cat("Number of observations:", nrow(data_subset), "\n")
  
  results_list <- list()
  
  for (i in seq_along(dep_vars)) {
    dep_var <- dep_vars[i]
    cat(paste(" Dependent variable:", dep_var, "\n"))
    
    if (!dep_var %in% names(data_subset)) {
      cat(paste("    ATTENTION: Variable", dep_var, "not found!\n"))
      next
    }
    
    control_subset <- data_subset %>% filter(INT_treatment == 0, RES05_gender == 0)
    control_mean <- if (nrow(control_subset) == 0) NA else control_subset %>%
      summarise(mean_val = mean(!!sym(dep_var), na.rm = TRUE)) %>%
      pull(mean_val) %>%
      round(2)
    
    cat(paste("    Control mean (non-previously gender-reserved):", control_mean, "\n"))
    
    available_controls <- gpcontrols[gpcontrols %in% names(data_subset)]
    reg_vars <- c(outregvar2, available_controls)
    reg_vars <- reg_vars[reg_vars %in% names(data_subset)]
    
    formula_str <- paste(dep_var, "~", paste(reg_vars, collapse = " + "), "+ factor(district)")
    
    tryCatch({
      model <- lm(as.formula(formula_str), data = data_subset)
      coef_names <- names(coef(model))
      
      res05_coef <- coef_names[grepl("RES05_gender", coef_names)]
      anytr_coef <- coef_names[grepl("X_anytr_genderres05", coef_names)]
      
      if (length(res05_coef) > 0 && length(anytr_coef) > 0) {
        L <- matrix(0, nrow = 1, ncol = length(coef(model)))
        names_L <- names(coef(model))
        L[1, which(names_L == res05_coef[1])] <- 1
        L[1, which(names_L == anytr_coef[1])] <- 1
        
        restriction <- L %*% coef(model)
        var_restriction <- L %*% vcov(model) %*% t(L)
        wald_stat <- as.numeric(restriction^2 / var_restriction)
        pval <- round(1 - pchisq(wald_stat, df = 1), 3)
      } else {
        pval <- NA
      }
      
      results_list[[i]] <- list(
        model = model,
        dep_var = dep_var,
        control_mean = control_mean,
        joint_test_pval = pval,
        subset = subset_name,
        formula = formula_str,
        n_obs = nrow(model$model)
      )
      
    }, error = function(e) {
      cat(paste("    ERROR in the regression:", e$message, "\n"))
      results_list[[i]] <- NULL
    })
  }
  
  results_list <- results_list[!sapply(results_list, is.null)]
  return(results_list)
}
```

We then split the analysis into three sub-samples.
```{r}
results_full <- run_regression_analysis(data_filtered, "Full Sample")
data_inc_can_run <- data_filtered %>% filter(INC05_can_run == 1)
results_inc_can <- run_regression_analysis(data_inc_can_run, "Incumbent Can Run")
data_inc_cannot_run <- data_filtered %>% filter(INC05_can_run == 0)
results_inc_cannot <- run_regression_analysis(data_inc_cannot_run, "Incumbent Cannot Run")
```

Output table into three panels, on the same .txt file.

```{r}
# Regression for each sample (each panel)
results_full <- run_regression_analysis(data_filtered, "Full Sample")
results_inc_can <- run_regression_analysis(data_inc_can_run, "Incumbent Can Run")
results_inc_cannot <- run_regression_analysis(data_inc_cannot_run, "Incumbent Cannot Run")

# Extract the results
panel_A_models <- lapply(results_full, function(x) x$model)
panel_B_models <- lapply(results_inc_can, function(x) x$model)
panel_C_models <- lapply(results_inc_cannot, function(x) x$model)

# Extract control means and p values for additional rows
control_means <- sapply(results_full, function(x) x$control_mean)
pvals <- sapply(results_full, function(x) x$joint_test_pval)

# Table for each panel, then combined into one txt file
panel_A <- stargazer(
  panel_A_models,
  type = "text",
  column.labels = c("Model 1", "Model 2", "Model 3", "Model 4", "Model 5", "Model 6"),
  keep = c("INT_treatment", "RES05_gender", "X_anytr_genderres05"),
  add.lines = list(
    c("District FE", rep("Yes", length(panel_A_models))),
    c("GP Controls", rep("Yes", length(panel_A_models))),
    c("Mean in Control not WR in 2005", control_means),
    c("Test Treat Effect", pvals)
  ),
  digits = 2,
  title = "Panel A: All GPs",
  single.row = TRUE
)

panel_B <- stargazer(
  panel_B_models,
  type = "text",
  column.labels = c("Model 1", "Model 2", "Model 3", "Model 4", "Model 5", "Model 6"),
  keep = c("INT_treatment", "RES05_gender", "X_anytr_genderres05"),
  add.lines = list(
    c("District FE", rep("Yes", length(panel_B_models))),
    c("GP Controls", rep("Yes", length(panel_B_models))),
    c("Mean in Control not WR in 2005", control_means),
    c("Test Treat Effect", pvals)
  ),
  digits = 2,
  title = "Panel B: Incumbent Can Run",
  single.row = TRUE
)

panel_C <- stargazer(
  panel_C_models,
  type = "text",
  column.labels = c("Model 1", "Model 2", "Model 3", "Model 4", "Model 5", "Model 6"),
  keep = c("INT_treatment", "RES05_gender", "X_anytr_genderres05"),
  add.lines = list(
    c("District FE", rep("Yes", length(panel_C_models))),
    c("GP Controls", rep("Yes", length(panel_C_models))),
    c("Mean in Control not WR in 2005", control_means),
    c("Test Treat Effect", pvals)
  ),
  digits = 2,
  title = "Panel C: Incumbent Cannot Run",
  single.row = TRUE
)

# Combine three panels
combined_output <- c(panel_A, "\n\n", panel_B, "\n\n", panel_C)
writeLines(combined_output, "Table3_Challengers_2010_completed.txt")
```


Non-formatted table to fit in the PDF: 
```{r}
create_outreg_table <- function(results_list_full, results_list_inc, results_list_no_inc) {
  extract_model_results <- function(model_result) {
    if (is.null(model_result) || is.null(model_result$model)) return(NULL)
    
    model <- model_result$model
    summary_model <- summary(model)
    coef_table <- summary_model$coefficients
    
    results <- list()
    for (var in outregvar2) {
      matching_vars <- rownames(coef_table)[grepl(var, rownames(coef_table))]
      if (length(matching_vars) > 0) {
        var_name <- matching_vars[1]
        coef_val <- coef_table[var_name, "Estimate"]
        se_val <- coef_table[var_name, "Std. Error"]
        pval <- coef_table[var_name, "Pr(>|t|)"]
        
        stars <- if (pval < 0.01) "***" else if (pval < 0.05) "**" else if (pval < 0.1) "*" else ""
        
        results[[var]] <- list(
          coef = round(coef_val, 3),
          se = round(se_val, 3),
          pval = pval,
          stars = stars,
          coef_formatted = paste0(round(coef_val, 3), stars),
          se_formatted = paste0("(", round(se_val, 3), ")")
        )
      } else {
        results[[var]] <- list(
          coef = NA,
          se = NA,
          pval = NA,
          stars = "",
          coef_formatted = "NA",
          se_formatted = "(NA)"
        )
      }
    }
    return(results)
  }
  
  final_table <- data.frame(
    Variable = character(),
    Full_Sample = character(),
    Inc_Can_Run = character(),
    Inc_Cannot_Run = character(),
    stringsAsFactors = FALSE
  )
  
  for (i in seq_along(dep_vars)) {
    dep_var <- dep_vars[i]
    full_results <- if (i <= length(results_list_full)) extract_model_results(results_list_full[[i]]) else NULL
    inc_results <- if (i <= length(results_list_inc)) extract_model_results(results_list_inc[[i]]) else NULL
    no_inc_results <- if (i <= length(results_list_no_inc)) extract_model_results(results_list_no_inc[[i]]) else NULL
    
    for (var in outregvar2) {
      coef_row <- data.frame(
        Variable = var,
        Full_Sample = if (!is.null(full_results[[var]])) full_results[[var]]$coef_formatted else "NA",
        Inc_Can_Run = if (!is.null(inc_results[[var]])) inc_results[[var]]$coef_formatted else "NA",
        Inc_Cannot_Run = if (!is.null(no_inc_results[[var]])) no_inc_results[[var]]$coef_formatted else "NA",
        stringsAsFactors = FALSE
      )
      
      se_row <- data.frame(
        Variable = paste0("  ", var, "_se"),
        Full_Sample = if (!is.null(full_results[[var]])) full_results[[var]]$se_formatted else "(NA)",
        Inc_Can_Run = if (!is.null(inc_results[[var]])) inc_results[[var]]$se_formatted else "(NA)",
        Inc_Cannot_Run = if (!is.null(no_inc_results[[var]])) no_inc_results[[var]]$se_formatted else "(NA)",
        stringsAsFactors = FALSE
      )
      
      final_table <- rbind(final_table, coef_row, se_row)
    }
  }
  
  return(final_table)
}

main_table <- create_outreg_table(results_full, results_inc_can, results_inc_cannot)
print(main_table)
```





## Table 4- Candidates 2015

Required libraries.
```{r}
library(tidyverse)
library(fixest)
library(stargazer)
library(haven)
```

Defining the macros: controls, regression variables.

```{r}
gpcontrols <- c("GP_population", "GP_lit", "GP_sc", "GP_st", "GP_nbvillages",
                "RES00_gender", "RES00_obc", "RES00_sc", "RES00_st",
                "RES10_obc", "RES10_sc", "RES10_st", "RES05_obc", "RES05_sc", "RES05_st")

gpcontrols15 <- c(gpcontrols, "RES15_obc", "RES15_sc", "RES15_st")

outregvar2 <- c("INT_treatment", "RES05_gender", "X_anytr_genderres05")
```

Data processing: upload and filter.

```{r}
# Change path depending on your workspace.
data <- read_dta("~/work/Electoral data 2015 cleaned.dta")

# Filtering the data
data_filtered <- data %>%
  filter(RES10_gender == 0, GP_tag == 1, RES15_gender == 0) %>%
  mutate(
    INC10_can_run = 1,
    INC10_can_run = ifelse(ELEC10_won_female == 0 & RES15_gender == 1, 0, INC10_can_run),
    INC10_can_run = ifelse(ELEC10_won_sc == 0 & RES15_sc == 1, 0, INC10_can_run),
    INC10_can_run = ifelse(ELEC10_won_st == 0 & RES15_st == 1, 0, INC10_can_run)
  )

# Generate new variables
for (var in c("INT_treatment", "X_anytr_genderres05", "RES05_gender")) {
  data_filtered <- data_filtered %>%
    mutate(!!paste0("X15_", var) := get(var) * (RES15_gender == 1))
}
```

Variables of the regression.
```{r}
outregvar15 <- c("INT_treatment", "RES05_gender", "X_anytr_genderres05", "RES15_gender",
                 "X15_INT_treatment", "X15_RES05_gender", "X15_X_anytr_genderres05")

# Dependent variables
dep_vars <- c("ELEC15_nbcands", "ELEC15_incum10_running", "ELEC15_voteshare_incum10",
              "ELEC15_prop_cand2010", "ELEC15_voteshare_cand2010", "ELEC15_prop_female",
              "ELEC15_voteshare_female", "ELEC15_prop_nongen", "ELEC15_voteshare_nongen")

```

Lists to stock the results.
```{r}
models_list <- list()
control_means <- numeric(length(dep_vars))
pvals <- numeric(length(dep_vars))
```

Regressions.
```{r}
for (i in seq_along(dep_vars)) {
  dep_var <- dep_vars[i]
  
  # control mean
  control_mean <- data_filtered %>%
    filter(INT_treatment == 0 & RES05_gender == 0) %>%
    summarise(mean = mean(!!sym(dep_var), na.rm = TRUE)) %>%
    pull(mean) %>%
    round(2)
  
  control_means[i] <- control_mean
  
  # model estimation
  formula <- as.formula(paste(dep_var, "~", paste(c(outregvar2, gpcontrols15), collapse = " + "), "+ factor(district)"))
  model <- lm(formula, data = data_filtered)
  models_list[[i]] <- model
  
  # do the test
  test_result <- summary(lm(test = RES05_gender + X_anytr_genderres05, data = model$model))$coefficients[2, 4]
  pvals[i] <- round(test_result, 2)
}

```

Output table in .txt file.
```{r}
stargazer(models_list,
          type = "text",
          column.labels = paste("Model", 1:length(dep_vars)),
          keep = outregvar2,
          add.lines = list(
            c("District FE", rep("Yes", length(dep_vars))),
            c("GP Controls", rep("Yes", length(dep_vars))),
            c("Mean in Control not WR in 2015", control_means),
            c("Test Treat Effect in WR=Treat Effect in NWR", pvals)
          ),
          digits = 2,
          title = "Table 4: Effects on Candidates - 2015",
          out = file.path("~/work/Rajasthan-Voters-Replication/Table4_Candidates_2015.txt"))

```


Non formatted table to fit into the PDF.
```{r}
create_regression_table <- function(models_list, dep_vars, outregvar2) {
  extract_model_results <- function(model) {
    if (is.null(model)) return(NULL)
    
    summary_model <- summary(model)
    coef_table <- summary_model$coefficients
    
    results <- list()
    for (var in outregvar2) {
      if (var %in% rownames(coef_table)) {
        coef_val <- coef_table[var, "Estimate"]
        se_val <- coef_table[var, "Std. Error"]
        pval <- coef_table[var, "Pr(>|t|)"]
        
        stars <- if (pval < 0.01) "***" else if (pval < 0.05) "**" else if (pval < 0.1) "*" else ""
        
        results[[var]] <- list(
          coef = round(coef_val, 3),
          se = round(se_val, 3),
          pval = pval,
          stars = stars,
          coef_formatted = paste0(round(coef_val, 3), stars),
          se_formatted = paste0("(", round(se_val, 3), ")")
        )
      } else {
        results[[var]] <- list(
          coef = NA,
          se = NA,
          pval = NA,
          stars = "",
          coef_formatted = "NA",
          se_formatted = "(NA)"
        )
      }
    }
    return(results)
  }
  
  final_table <- data.frame(
    Variable = character(),
    stringsAsFactors = FALSE
  )
  
  for (i in seq_along(dep_vars)) {
    dep_var <- dep_vars[i]
    model_results <- extract_model_results(models_list[[i]])
    
    for (var in outregvar2) {
      coef_row <- data.frame(
        Variable = var,
        stringsAsFactors = FALSE
      )
      
      se_row <- data.frame(
        Variable = paste0("  ", var, "_se"),
        stringsAsFactors = FALSE
      )
      
      for (j in seq_along(models_list)) {
        col_name <- paste0("Model_", j)
        coef_row[[col_name]] <- if (!is.null(model_results[[var]])) model_results[[var]]$coef_formatted else "NA"
        se_row[[col_name]] <- if (!is.null(model_results[[var]])) model_results[[var]]$se_formatted else "(NA)"
      }
      
      final_table <- rbind(final_table, coef_row, se_row)
    }
  }
  
  return(final_table)
}

regression_table <- create_regression_table(models_list, dep_vars, outregvar2)
print(regression_table)
```


## Table 5 - Voters perception

